# v0.8.0 Implementation Guide - Energy System & Daily Reset & Leaderboards

**Author:** Roman HlavÃ¡Äek - rhsoft.cz
**Date:** 2025-11-08
**Version:** 0.8.0

---

## ğŸ“‹ Overview

Version 0.8.0 implements the **Energy System**, **Daily Reset**, and **Leaderboards** features for Looters Land.

### Features Implemented:

âœ… **Energy Regeneration System** - Automatic energy regeneration (10/hour)
âœ… **Daily Reset Service** - Server-side Edge Function for daily resets
âœ… **Leaderboard Database Schema** - 4 competitive categories
âœ… **LeaderboardService** - Client-side service for rankings
âœ… **LeaderboardScreen UI** - Full leaderboard interface

---

## ğŸ¯ Implementation Status

| Feature | Status | Files | Notes |
|---------|--------|-------|-------|
| Energy Regeneration | âœ… Complete | `useEnergyRegeneration.ts` | 10 energy/hour, client-side timer |
| Daily Reset Edge Function | âœ… Complete | `supabase/functions/daily-reset/` | Server-side midnight reset |
| Daily Reset Client Service | âœ… Complete | `DailyResetService.ts` | Client-side reset checks |
| Leaderboard Schema | âœ… Complete | `leaderboards_schema.sql` | 3 tables + functions |
| LeaderboardService | âœ… Complete | `LeaderboardService.ts` | Full CRUD operations |
| LeaderboardScreen UI | âœ… Complete | `LeaderboardScreen.tsx` | Responsive UI with tabs |
| GameLayout Integration | âœ… Complete | `GameLayout.tsx`, `MainSidebar.tsx` | Navigation added |

---

## ğŸ“ New Files Created

### Hooks
- âœ… `src/hooks/useEnergyRegeneration.ts` - Energy regeneration hook

### Services
- âœ… `src/services/DailyResetService.ts` - Daily reset utilities
- âœ… `src/services/LeaderboardService.ts` - Leaderboard API wrapper

### Components
- âœ… `src/components/LeaderboardScreen.tsx` - Leaderboard UI

### Database
- âœ… `supabase/leaderboards_schema.sql` - Database schema
- âœ… `supabase/daily_reset_edge_function.sql` - SQL documentation
- âœ… `supabase/functions/daily-reset/index.ts` - Edge Function

---

## ğŸš€ Deployment Steps

### 1. Database Schema Setup

Run the leaderboard schema SQL file in Supabase:

```sql
-- In Supabase SQL Editor
-- Run: looters-land/supabase/leaderboards_schema.sql
```

This creates:
- `daily_leaderboards` table
- `daily_leaderboards_archive` table
- `player_leaderboard_stats` table
- Functions: `update_leaderboard_entry()`, `calculate_rankings()`, `archive_leaderboards()`
- RLS policies

### 2. Deploy Supabase Edge Function

```bash
# Navigate to project root
cd looters-land

# Login to Supabase CLI
supabase login

# Deploy the daily-reset Edge Function
supabase functions deploy daily-reset

# Set environment variables
supabase secrets set SUPABASE_URL=your_supabase_url
supabase secrets set SUPABASE_SERVICE_ROLE_KEY=your_service_key
```

### 3. Schedule Daily Reset (Optional)

Set up a cron job to trigger the Edge Function daily at 00:00 UTC:

**Option A: Supabase Cron (if available)**
```sql
-- In Supabase SQL Editor
SELECT cron.schedule(
  'daily-reset-trigger',
  '0 0 * * *', -- Every day at midnight UTC
  $$
  SELECT net.http_post(
    url:='https://your-project.supabase.co/functions/v1/daily-reset',
    headers:='{"Authorization": "Bearer YOUR_ANON_KEY"}'::jsonb
  )
  $$
);
```

**Option B: External Cron Service**
- Use services like cron-job.org, EasyCron, or AWS EventBridge
- Set URL: `https://your-project.supabase.co/functions/v1/daily-reset`
- Add header: `Authorization: Bearer YOUR_ANON_KEY`
- Schedule: Daily at 00:00 UTC

### 4. Frontend Integration

The frontend is already integrated. To use LeaderboardScreen:

```typescript
// In WorldMapDemo2.tsx or similar
import { LeaderboardScreen } from './components/LeaderboardScreen';

const leaderboardsContent = (
  <LeaderboardScreen
    userId={userId}
    playerName={playerName}
    playerLevel={playerLevel}
  />
);

<GameLayout
  // ... other props
  leaderboardsScreen={leaderboardsContent}
/>
```

---

## ğŸ® How It Works

### Energy Regeneration

1. **Hook**: `useEnergyRegeneration` runs a timer every 60 seconds
2. **Rate**: 10 energy per hour (configurable)
3. **Auto-save**: Energy updates trigger auto-save via `useGameState`
4. **Calculation**: `energyToAdd = timePassed / msPerEnergy`

### Daily Reset

1. **Client Check**: `DailyResetService.shouldPerformDailyReset()` checks last login date
2. **Server Reset**: Edge Function runs at midnight:
   - Restores all players' energy to max
   - Archives previous day's leaderboards
   - Resets daily stats

3. **WorldMap Seed**: `daily-${YYYY-MM-DD}` - auto-generates new map each day

### Leaderboards

**4 Categories:**
1. ğŸ•³ï¸ Deepest Floor Reached
2. ğŸ’° Total Gold Earned
3. ğŸ‘¥ Heroes Collected
4. âš”ï¸ Combat Power

**Flow:**
1. Player achieves something â†’ Call `LeaderboardService.updateLeaderboardEntry()`
2. Database function `update_leaderboard_entry()` updates score
3. Rankings calculated via `calculate_rankings()`
4. LeaderboardScreen displays top 100 + player rank

---

## ğŸ”§ Configuration

### Energy Regeneration Rate

In `WorldMapDemo2.tsx`:

```typescript
const energyRegen = useEnergyRegeneration({
  currentEnergy: gameState.energy,
  maxEnergy: gameState.maxEnergy,
  onEnergyChange: (newEnergy) => gameActions.setEnergy(newEnergy),
  regenRate: 10, // â† Change this (energy per hour)
  enabled: true
});
```

### Leaderboard Update Frequency

To update leaderboards, call after major events:

```typescript
// After completing a dungeon floor
await LeaderboardService.updateLeaderboardEntry(
  userId,
  'deepest_floor',
  currentFloor,
  playerName,
  playerLevel
);

// After earning gold
await LeaderboardService.updateLeaderboardEntry(
  userId,
  'total_gold',
  totalGold,
  playerName,
  playerLevel
);
```

---

## ğŸ§ª Testing Checklist

### Energy System
- [ ] Energy regenerates 10/hour (check after 6 minutes = +1 energy)
- [ ] Energy stops at max (doesn't exceed maxEnergy)
- [ ] Movement costs energy correctly
- [ ] Dungeon entry costs 10 energy
- [ ] UI shows correct energy bar fill %

### Daily Reset
- [ ] Daily worldmap seed changes at midnight
- [ ] Energy restored to max after reset
- [ ] Free gacha summon available after reset

### Leaderboards
- [ ] All 4 categories display correctly
- [ ] Player's rank shows when they have a score
- [ ] Top 100 list loads and displays
- [ ] Switching categories works smoothly
- [ ] Reset timer counts down correctly
- [ ] Updating score reflects in leaderboard

---

## ğŸ› Known Issues / TODO

### High Priority
- [ ] Apply database migration: `leaderboards_schema.sql`
- [ ] Deploy Edge Function: `daily-reset`
- [ ] Set up cron trigger for Edge Function

### Medium Priority
- [ ] Add leaderboard update calls after game events
- [ ] Test ranking calculation performance with many players
- [ ] Add animations for rank changes

### Low Priority
- [ ] Add historical leaderboard view (past days)
- [ ] Add reward system for top ranks
- [ ] Add friend-only leaderboards filter

---

## ğŸ“Š Database Schema Reference

### `daily_leaderboards`
```sql
- id (UUID)
- user_id (UUID) â†’ auth.users
- date (DATE)
- category (ENUM)
- rank (INTEGER)
- score (BIGINT)
- player_name (TEXT)
- player_level (INTEGER)
- deepest_floor (INTEGER)
- total_gold (BIGINT)
- heroes_collected (INTEGER)
- combat_power (INTEGER)
```

### `daily_leaderboards_archive`
```sql
- id (UUID)
- date (DATE)
- category (ENUM)
- top_players (JSONB) -- Top 100 as JSON
- total_participants (INTEGER)
- highest_score (BIGINT)
- average_score (BIGINT)
```

### `player_leaderboard_stats`
```sql
- user_id (UUID)
- current_deepest_floor (INTEGER)
- current_total_gold (BIGINT)
- current_heroes_collected (INTEGER)
- current_combat_power (INTEGER)
- best_deepest_floor (INTEGER)
- best_total_gold (BIGINT)
- best_heroes_collected (INTEGER)
- best_combat_power (INTEGER)
```

---

## ğŸ¯ Next Steps (v0.9.0 - Town System)

1. **Tavern Building** - Gacha summons UI
2. **Smithy Building** - Equipment forge/enhance
3. **Healer Building** - HP restoration
4. **Market Building** - Buy/sell items
5. **Bank Building** - Gold storage with interest
6. **Guild Hall** - Guild management

---

## ğŸ“ Support

**Issues?** Check:
1. Console logs for errors
2. Supabase dashboard for Edge Function logs
3. Database RLS policies are enabled
4. Edge Function environment variables set

**Author:** Roman HlavÃ¡Äek - rhsoft.cz
**Project:** Looters Land
**Version:** 0.8.0
**Date:** 2025-11-08
